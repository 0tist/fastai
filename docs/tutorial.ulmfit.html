---

title: Transfer learning in text

keywords: fastai
sidebar: home_sidebar

summary: "How to fine-tune a language model and train a classifier"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/38_tutorial.ulmfit.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.text.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># all_slow</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Finetune-a-pretrained-Language-Model">Finetune a pretrained Language Model<a class="anchor-link" href="#Finetune-a-pretrained-Language-Model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we get our data and tokenize it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">IMDB_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;texts.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we put it in a <a href="/data.core#Datasets"><code>Datasets</code></a>. For a language model, we don't have targets, so there is only one transform to numericalize the texts.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df</span><span class="p">)</span>
<span class="n">tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">()]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="n">tfms</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">LMDataLoader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we use that <a href="/data.core#Datasets"><code>Datasets</code></a> to create a <a href="/data.core#DataLoaders"><code>DataLoaders</code></a>. Here the class of <a href="/data.core#TfmdDL"><code>TfmdDL</code></a> we need to use is <a href="/text.data#LMDataLoader"><code>LMDataLoader</code></a> which will concatenate all the texts in a source (with a shuffle at each epoch for the training set), split it in <code>bs</code> chunks then read continuously through it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">72</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or more simply with a factory method:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">TextDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">is_lm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>text_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj she is such an extraordinary singer , who cares about anything else xxrep 4 ! xxmaj that final scene is one of the best moments in all of show biz - bar none ! ! xxmaj i 'm glad she kept the camera on herself for ten minutes - she deserves that xxunk status - such is the power of the voice . \n\n i first saw this film when</td>
      <td>xxmaj she is such an extraordinary singer , who cares about anything else xxrep 4 ! xxmaj that final scene is one of the best moments in all of show biz - bar none ! ! xxmaj i 'm glad she kept the camera on herself for ten minutes - she deserves that xxunk status - such is the power of the voice . \n\n i first saw this film when i</td>
    </tr>
    <tr>
      <th>1</th>
      <td>subjects ! xxmaj brooks xxunk wildly from that approach in favor of something closer to xxunk . xxmaj although he films on actual locations , he keeps his distance . xxmaj the murderers are portrayed as xxunk xxunk , which surely they were . xxmaj they 're not seen as xxunk souls ( as in the xxmaj capote book ) and the xxunk of their act is xxunk blunt . xxmaj scott</td>
      <td>! xxmaj brooks xxunk wildly from that approach in favor of something closer to xxunk . xxmaj although he films on actual locations , he keeps his distance . xxmaj the murderers are portrayed as xxunk xxunk , which surely they were . xxmaj they 're not seen as xxunk souls ( as in the xxmaj capote book ) and the xxunk of their act is xxunk blunt . xxmaj scott xxmaj</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we have a convenience method to directly grab a <a href="/learner#Learner"><code>Learner</code></a> from it, using the <a href="/text.models.awdlstm#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">language_model_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">Perplexity</span><span class="p">()],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">opt_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.551264</td>
      <td>4.051460</td>
      <td>0.274317</td>
      <td>57.481308</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.306946</td>
      <td>4.135892</td>
      <td>0.259530</td>
      <td>62.545353</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4.125319</td>
      <td>4.083847</td>
      <td>0.269220</td>
      <td>59.373413</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3.812951</td>
      <td>4.044264</td>
      <td>0.276182</td>
      <td>57.069160</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3.441317</td>
      <td>4.084253</td>
      <td>0.273413</td>
      <td>59.397541</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have fine-tuned the pretrained language model to this corpus, we save the encoder since we will use it for the classifier.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>input</th>
      <th>target</th>
      <th>pred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj this is one of my all - time favorite films , and while it may move too slowly for some , it 's well worth seeing . a corporate lawyer ( richard xxmaj chamberlain ) is dragged into a case involving " city " xxmaj aborigines , and this is no ordinary case . xxup ok , a man has died but it was n't exactly a normal killing .</td>
      <td>xxmaj this is one of my all - time favorite films , and while it may move too slowly for some , it 's well worth seeing . a corporate lawyer ( richard xxmaj chamberlain ) is dragged into a case involving " city " xxmaj aborigines , and this is no ordinary case . xxup ok , a man has died but it was n't exactly a normal killing . xxmaj</td>
      <td>xxmaj this is a of the favorite time time favorite movies . and i i is be far far , me kind it 's a worth watching . xxmaj good xxunk , xxunk xxmaj xxunk ) has a into the xxunk of a xxunk xxunk xxunk xxunk ( who his is one xxunk xxunk of xxmaj xxunk , the good who a in he is n't . what xxunk man . xxmaj</td>
    </tr>
    <tr>
      <th>1</th>
      <td>'s greatest xxunk xxunk and given a taste of her xxunk . \n\n xxmaj in regard to the casting : because we in xxunk territory the only people who really matter are xxmaj modesty and ( perhaps ) xxmaj professor xxmaj xxunk . xxmaj for me they were totally credible . xxmaj xxunk xxmaj xxunk , described by some as wooden , and too thin to be an action heroine , brought</td>
      <td>greatest xxunk xxunk and given a taste of her xxunk . \n\n xxmaj in regard to the casting : because we in xxunk territory the only people who really matter are xxmaj modesty and ( perhaps ) xxmaj professor xxmaj xxunk . xxmaj for me they were totally credible . xxmaj xxunk xxmaj xxunk , described by some as wooden , and too thin to be an action heroine , brought to</td>
      <td>xxunk hits . . xxunk the xxunk at the xxunk . xxmaj xxmaj the the to the xxunk , xxmaj of are the are are xxmaj xxunk in can could in in xxunk , xxmaj xxunk ) xxmaj xxunk xxmaj xxunk xxmaj xxmaj the example , have n't xxunk . xxmaj the xxmaj xxunk was who by xxmaj xxunk " , was xxunk xxunk , be a xxunk star , was a</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxmaj xxunk ) xxunk , xxmaj homer xxunk the help of the nerdy xxmaj quentin xxmaj wilson ( chris xxmaj owen ) . xxmaj quentin asks xxmaj homer , " what do you want to know about rockets ? " xxmaj homer quickly xxunk , " everything . " xxmaj his science teacher at xxmaj big xxmaj xxunk xxmaj high xxmaj school , xxmaj miss xxmaj xxunk xxmaj riley ( laura xxmaj</td>
      <td>xxunk ) xxunk , xxmaj homer xxunk the help of the nerdy xxmaj quentin xxmaj wilson ( chris xxmaj owen ) . xxmaj quentin asks xxmaj homer , " what do you want to know about rockets ? " xxmaj homer quickly xxunk , " everything . " xxmaj his science teacher at xxmaj big xxmaj xxunk xxmaj high xxmaj school , xxmaj miss xxmaj xxunk xxmaj riley ( laura xxmaj xxunk</td>
      <td>xxunk xxmaj . the xxunk xxunk and his xxunk of the xxmaj xxmaj xxunk xxmaj xxunk , xxunk xxmaj xxunk ) , xxmaj the xxmaj xxmaj james to and if is you want to see ? him , " xxmaj but says xxunk xxmaj and you is " xxmaj but xxunk is , the xxunk xxmaj ben , xxunk xxmaj school is xxmaj xxunk xxmaj xxunk , xxunk ( xxunk xxmaj xxunk</td>
    </tr>
    <tr>
      <th>3</th>
      <td>. xxmaj if i wrote something as boring and utterly ridiculous as this i would be laughed at and too embarrassed to subject others to the stupidity of it . xxmaj second : the acting is terrible and the lead actress is excruciatingly ugly . xxmaj third : the story sucks , its been used before , and the excuse that its a cheap movie is no excuse . xxmaj read the</td>
      <td>xxmaj if i wrote something as boring and utterly ridiculous as this i would be laughed at and too embarrassed to subject others to the stupidity of it . xxmaj second : the acting is terrible and the lead actress is excruciatingly ugly . xxmaj third : the story sucks , its been used before , and the excuse that its a cheap movie is no excuse . xxmaj read the xxunk</td>
      <td>xxmaj the you had this about well as xxunk xxunk , the one would have xxunk out . i much to be this to . plot of the . xxmaj the , xxmaj xxunk was xxunk , the acting actor is xxunk poor . xxmaj the , xxmaj second is , but not xxunk as the but it acting for you xxunk good xxunk is made longer to xxmaj the the script</td>
    </tr>
    <tr>
      <th>4</th>
      <td>make - up , which also received an xxmaj academy xxmaj award . xxmaj of course if you 're a xxmaj jim xxmaj xxunk xxunk you should n't even think about watching this movie . xxmaj this movie is really his movie and he makes it all work and so much fun to watch . xxmaj other fun and memorable roles are being played by xxmaj jeffrey xxmaj xxunk , xxmaj clint</td>
      <td>- up , which also received an xxmaj academy xxmaj award . xxmaj of course if you 're a xxmaj jim xxmaj xxunk xxunk you should n't even think about watching this movie . xxmaj this movie is really his movie and he makes it all work and so much fun to watch . xxmaj other fun and memorable roles are being played by xxmaj jeffrey xxmaj xxunk , xxmaj clint xxmaj</td>
      <td>- up effects and is includes a xxunk oscar xxmaj award nomination xxmaj the course , you are a fan jane xxmaj xxunk fan , will be be be that this this movie . xxmaj it is is a a best . it 's a a the . makes does . . watch . xxmaj it than in fun movies are the xxunk by xxmaj xxunk xxmaj anderson and xxmaj xxunk xxmaj</td>
    </tr>
    <tr>
      <th>5</th>
      <td>dog , with a smile . xxmaj just pathetic . xxbos i found this very touching as xxmaj spike and xxmaj heaton stay together all the way through this film not to say there is n't a few xxunk along the way . i thought the chase was put aside the relationship between the two was foreground i think . i had already guessed that there were so gay intentions on the</td>
      <td>, with a smile . xxmaj just pathetic . xxbos i found this very touching as xxmaj spike and xxmaj heaton stay together all the way through this film not to say there is n't a few xxunk along the way . i thought the chase was put aside the relationship between the two was foreground i think . i had already guessed that there were so gay intentions on the part</td>
      <td>, xxmaj a xxunk and xxmaj the like . xxmaj xxmaj was this movie funny and a xxunk xxmaj xxmaj lee were in . the way through the film . to be that was a a lot good of the way . xxmaj was it film scenes a together by way between xxmaj two characters a and thought . xxmaj was to seen the the was a many characters in screen film</td>
    </tr>
    <tr>
      <th>6</th>
      <td>the film is gorgeous but it is like the beauty of a very attractive , xxunk xxunk whose voice , appearance and every touch are thrilling . xxmaj but under that very feminine surface lies an ominous secret . xxmaj under the xxunk appearing xxmaj japanese surface of the film xxunk the ominous secret that the heart , soul , spirit and core of this film is entirely xxmaj american and male</td>
      <td>film is gorgeous but it is like the beauty of a very attractive , xxunk xxunk whose voice , appearance and every touch are thrilling . xxmaj but under that very feminine surface lies an ominous secret . xxmaj under the xxunk appearing xxmaj japanese surface of the film xxunk the ominous secret that the heart , soul , spirit and core of this film is entirely xxmaj american and male .</td>
      <td>xxmaj 's a . it 's not a xxmaj of a film realistic director xxunk , . xxunk is xxunk and xxunk other is xxunk . xxmaj the the the impression light character , in xxunk xxunk . xxmaj the the xxunk , in xxunk , xxunk the xxmaj , , xxunk xxunk xxunk is film is xxunk , and , soul are the film is xxunk xxunk japanese . xxmaj .</td>
    </tr>
    <tr>
      <th>7</th>
      <td>that if this had been my xxunk play at primary school , my xxunk would have burst out crying at our talent . \n\n xxmaj of course i realise that this is a very low budget film and that in those cases one should lower one 's expectations , certainly as far as things like special effects are concerned . xxmaj also , even though xxmaj i 'm a big fan of</td>
      <td>if this had been my xxunk play at primary school , my xxunk would have burst out crying at our talent . \n\n xxmaj of course i realise that this is a very low budget film and that in those cases one should lower one 's expectations , certainly as far as things like special effects are concerned . xxmaj also , even though xxmaj i 'm a big fan of the</td>
      <td>'s you is been done favorite , , all school , i xxunk would have been into of . the local . xxmaj xxmaj the course , was that the movie a film good budget movie . that the the days i of have the 's opinion . and not it as it are this effects are done . xxmaj the , the though the i 'm not huge fan of xxmaj</td>
    </tr>
    <tr>
      <th>8</th>
      <td>in any gunfights , and he was hardly more than an older version of xxmaj little xxmaj joe . xxmaj for a year or two they also had xxmaj ben take in some other lost cousin ( jamie , played by the forgettable xxmaj mitch xxmaj xxunk ) who was a teenager that was usually getting into some kind of trouble with someone . \n\n xxmaj apparently by adding the teenager ,</td>
      <td>any gunfights , and he was hardly more than an older version of xxmaj little xxmaj joe . xxmaj for a year or two they also had xxmaj ben take in some other lost cousin ( jamie , played by the forgettable xxmaj mitch xxmaj xxunk ) who was a teenager that was usually getting into some kind of trouble with someone . \n\n xxmaj apparently by adding the teenager , the</td>
      <td>the case , it the 's xxunk able than a xxunk man of xxmaj xxunk xxmaj bill . xxmaj the me while after so , would have a xxunk xxmaj the his of xxunk jobs to xxunk xxmaj xxmaj by xxmaj xxmaj xxmaj xxunk xxmaj xxunk ) , was a xxunk who was a xxunk xxunk his kind of xxmaj with his else xxmaj xxmaj the , the some same 's xxmaj</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-it-to-train-a-classifier">Use it to train a classifier<a class="anchor-link" href="#Use-it-to-train-a-classifier">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For classification, we need to use two set of transforms: one to numericalize the texts and the other to encode the labels as categories. Note that we have to use the same vocabulary as the one used in fine-tuning the language model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lm_vocab</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df</span><span class="p">)</span>
<span class="n">x_tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="n">lm_vocab</span><span class="p">)]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">x_tfms</span><span class="p">,</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span> <span class="n">Categorize</span><span class="p">()]],</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">SortedDL</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We once again use a subclass of <a href="/data.core#TfmdDL"><code>TfmdDL</code></a> for the dataloaders, since we want to sort the texts (sortish for the training set) by order of lengths. We also use <code>pad_collate</code> to create batches form texts of different lengths.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">before_batch</span><span class="o">=</span><span class="n">pad_input_chunk</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And there is a factory method, once again:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">TextDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text_vocab</span><span class="o">=</span><span class="n">lm_vocab</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj this tale set in xxmaj xxunk , xxmaj new xxmaj zealand xxunk ( xxunk xxunk of the xxunk xxmaj xxunk xxmaj college ) is xxunk 's first feature . \n\n xxmaj with a contemporary xxmaj new xxmaj zealand xxunk xxmaj via xxmaj satellite xxunk with absolutely hilarious situations which develop in the ( adult ) family context .</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos a complete waste of time \n\n xxmaj xxunk xxmaj xxunk is a complete waste of time . xxmaj the script and dialogues are poorly written , the direction is xxunk and the acting borders on xxunk movie was clearly aiming for the xxmaj xxunk xxmaj de xxmaj xxunk crowd but it falls far short of the mark because it</td>
      <td>negative</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we once again have a convenience function to create a classifier from this <a href="/data.core#DataLoaders"><code>DataLoaders</code></a> with the <a href="/text.models.awdlstm#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span><span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">load_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we can train with gradual unfreezing and differential learning rates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.693843</td>
      <td>0.619068</td>
      <td>0.675000</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.598153</td>
      <td>0.524340</td>
      <td>0.750000</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.553578</td>
      <td>0.452283</td>
      <td>0.790000</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.507784</td>
      <td>0.445195</td>
      <td>0.795000</td>
      <td>00:08</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.432331</td>
      <td>0.455946</td>
      <td>0.790000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.444038</td>
      <td>0.486405</td>
      <td>0.765000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.420263</td>
      <td>0.436845</td>
      <td>0.795000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.403579</td>
      <td>0.453961</td>
      <td>0.780000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.370442</td>
      <td>0.438987</td>
      <td>0.795000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.336611</td>
      <td>0.448312</td>
      <td>0.805000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.316630</td>
      <td>0.422411</td>
      <td>0.790000</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.298391</td>
      <td>0.428246</td>
      <td>0.795000</td>
      <td>00:13</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
      <th>category_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj hmm , imdb rating of xxunk , good comments , xxunk , xxunk … okay , two of my friends and me , we xxunk xxmaj xxunk , sat down and wanted to see something as cool as xxmaj xxunk or at least something xxunk but funny like xxmaj versus . xxmaj but xxmaj naked xxmaj blood sucked</td>
      <td>negative</td>
      <td>negative</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos i am sick and tired of all these little xxunk going on about how this movie " xxunk " . xxmaj it is pure xxup xxunk over - acted xxup crap ! xxmaj do n't send an xxmaj assassin , it 's much more sensible to xxunk hundreds of xxunk colored , aggressive , xxunk xxmaj snakes on a</td>
      <td>negative</td>
      <td>negative</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxbos xxmaj an excellent performance by xxmaj xxunk xxmaj xxunk highlights an otherwise xxunk - directed and confused pile of dreck . i have seen this movie , perhaps 12 times , and with each run through , i find less and less pleasure . xxmaj why are xxmaj xxunk so xxunk ? xxmaj is that ever explained ? xxmaj</td>
      <td>negative</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>3</th>
      <td>xxbos xxmaj tears of xxmaj xxunk is an original yet flawed horror film that delves into the xxunk of a cult group in xxmaj india comprised of xxmaj german xxunk who have learned how to control their xxunk and their bodies to the point that they can cause others to be " xxunk " through radical techniques ( that can</td>
      <td>positive</td>
      <td>positive</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="s2">&quot;This was a good movie&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;positive&#39;, tensor(1), tensor([0.1073, 0.8927]))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.interpret</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">Interpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>input</th>
      <th>target</th>
      <th>predicted</th>
      <th>probability</th>
      <th>loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos " how xxmaj to xxmaj lose xxmaj friends &amp; xxmaj alienate xxmaj people " is not based on xxmaj xxunk xxmaj woods ' xxunk . xxmaj it is a mediocre romantic comedy based on xxmaj toby xxmaj young 's book on his experiences working as a journalist covering xxunk . xxmaj the film stars xxmaj simon xxmaj pegg as xxmaj sidney xxmaj young , a xxunk xxmaj british journalist who takes a job in an illustrious celebrity magazine in xxmaj new xxmaj york . xxmaj young is xxunk in getting caught up all type of shenanigans to alienate all around him , hence movie title . xxmaj he is xxunk , daring , and moronic . xxmaj but nevertheless for some very bizarre reason , he is a somewhat likable character . xxmaj sidney xxunk a fellow journalist , the composed xxmaj alison xxmaj xxunk , played quite xxunk</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9839469194412231</td>
      <td>4.131855010986328</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos xxmaj i 'm gon na xxunk the xxunk here a bit and say i enjoyed this . xxmaj however , the cartoon is really only going to appeal to those who have very xxunk xxunk . xxmaj it 's definitely something that most people will not get , as is the nature of xxunk . \n\n the animation is horrible , but yes , that 's the point . xxmaj the main character is foul mouthed , violent , and stupid . no redeeming qualities whatsoever . his wife xxunk and xxunk , apparently just barely capable of the most basic xxunk skills . most of these stories completely lack any kind of point . \n\n but again , that 's the point xxunk \n\n xxmaj if non xxunk , foul language , and complete and utter xxunk are your thing , you 're going to love this .</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9617658257484436</td>
      <td>3.264024257659912</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxbos i caught xxmaj evening in the cinema with a lady friend . xxmaj evening is a chick flick with no apologies for being such , but i can say with some relief that it 's not so infused with xxunk that it 's painful for a red - blooded male to watch . xxmaj except for a single instance at the very end of the movie , i watched with interest and did not have to turn away or roll my eyes at any self - indulgent melodrama . xxmaj ladies , for their part , will absolutely love this movie . \n\n xxmaj ann xxmaj lord is elderly , bed - ridden and spending her last few days on xxmaj earth as xxunk as possible in her own home with her two grown daughters at her side . xxmaj xxunk by the memories of her past , xxmaj</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9489893913269043</td>
      <td>2.975722312927246</td>
    </tr>
    <tr>
      <th>3</th>
      <td>xxbos xxmaj in 17th xxmaj century xxmaj japan , there lived a samurai who would set the standard for the ages . xxmaj his name was xxmaj mayeda . xxmaj he is sent on an epic journey across the world to acquire 5 , xxrep 3 0 xxunk from the xxmaj king of xxmaj xxunk . xxmaj whilst at sea a violent storm xxunk their precious gold intended to buy the weapons and almost takes their lives . xxmaj mayeda must battle all odds to survive and the secure the fate of his beloved xxmaj japan . xxmaj xxunk xxmaj mayeda is a multi million dollar action adventure epic set across three xxunk . \n\n xxmaj starring cinema legends xxmaj sho xxmaj xxunk ( xxunk : xxmaj xxunk xxmaj xxunk ) , xxmaj christopher xxmaj lee ( star xxmaj wars , xxmaj lord of the xxmaj rings xxmaj trilogy )</td>
      <td>negative</td>
      <td>positive</td>
      <td>0.9426563382148743</td>
      <td>2.8586931228637695</td>
    </tr>
    <tr>
      <th>4</th>
      <td>xxbos xxmaj merry xxunk in xxmaj london stage a treasure hunt , with one young woman inadvertently xxunk up her married politician father with a strong , independent lady - xxunk who 's never been in love . xxmaj intriguing early vehicle for xxmaj xxunk xxmaj xxunk , playing an xxmaj xxunk xxmaj xxunk - like xxunk who 's been too self - involved to give herself over to any man . xxmaj the director ( dorothy xxmaj xxunk ) and the screenwriter ( zoe xxmaj xxunk , who adapted xxmaj xxunk xxmaj xxunk 's book ) were obviously assigned to this project to get the female point of view , but why are all the old clichés kept intact like frozen artifacts ? xxmaj xxunk xxmaj burke plays the type of xxunk , xxunk wife who takes to her bed when thing go wrong , and xxmaj xxunk 's</td>
      <td>negative</td>
      <td>positive</td>
      <td>0.933489978313446</td>
      <td>2.7104034423828125</td>
    </tr>
    <tr>
      <th>5</th>
      <td>xxbos xxmaj forget the campy ' religious ' movies that have xxunk the television / film market … this movie has a real feel to it . xxmaj while it may be deemed as a movie that has cheap emotional draws , it also has that message of xxunk , and overall good morals . xxmaj however , i did not like the lighting in this movie … for a movie dealing with such subject matter , it was too bright . i felt it took away from the overall appeal of the movie , which is almost an xxunk sin , but the recognizable cast , and their performances xxunk this xxunk . \n\n xxmaj definitely worth seeing … buy the xxup dvd .</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.8967933058738708</td>
      <td>2.2710211277008057</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}
</div>
 

